{% extends "dashboard/dashboard.html" %}
{% load static %}

{% block title %}{{ page_title|default:"Edit Section" }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'dashboard/css/onboard.css' %}" type="text/css">
{% endblock %}

{% block messages %}
{% endblock %}

{% block content %}
<div class="onboarding-wrap">

  <!-- ── SECTION NAV RAIL ─────────────────────────────── -->
  <aside class="step-rail">
    <div class="rail-header">
      <h2>Funeral Plan</h2>
      <p>Editing a single section</p>
    </div>

    <div class="rail-steps">

      {% with sl=section_label %}

      <div class="rail-step {% if sl == 'Personal Information' %}active{% else %}todo{% endif %}">
        <div class="rail-dot">{% if sl == 'Personal Information' %}<i class="fas fa-pen"></i>{% else %}1{% endif %}</div>
        <div class="rail-text">
          <span class="rail-label">Personal Info</span>
          <span class="rail-sub">Identity &amp; background</span>
        </div>
      </div>

      <div class="rail-step {% if sl == 'Service Preferences' %}active{% else %}todo{% endif %}">
        <div class="rail-dot">{% if sl == 'Service Preferences' %}<i class="fas fa-pen"></i>{% else %}2{% endif %}</div>
        <div class="rail-text">
          <span class="rail-label">Service</span>
          <span class="rail-sub">Type, venue &amp; timing</span>
        </div>
      </div>

      <div class="rail-step {% if sl == 'Final Disposition' %}active{% else %}todo{% endif %}">
        <div class="rail-dot">{% if sl == 'Final Disposition' %}<i class="fas fa-pen"></i>{% else %}3{% endif %}</div>
        <div class="rail-text">
          <span class="rail-label">Disposition</span>
          <span class="rail-sub">Burial or cremation</span>
        </div>
      </div>

      <div class="rail-step {% if sl == 'Ceremony Personalization' %}active{% else %}todo{% endif %}">
        <div class="rail-dot">{% if sl == 'Ceremony Personalization' %}<i class="fas fa-pen"></i>{% else %}4{% endif %}</div>
        <div class="rail-text">
          <span class="rail-label">Ceremony</span>
          <span class="rail-sub">Music, readings &amp; customs</span>
        </div>
      </div>

      <div class="rail-step {% if sl == 'Reception / Gathering' %}active{% else %}todo{% endif %}">
        <div class="rail-dot">{% if sl == 'Reception / Gathering' %}<i class="fas fa-pen"></i>{% else %}5{% endif %}</div>
        <div class="rail-text">
          <span class="rail-label">Reception</span>
          <span class="rail-sub">Gathering preferences</span>
        </div>
      </div>

      <div class="rail-step {% if sl == 'Obituary & Memorial' %}active{% else %}todo{% endif %}">
        <div class="rail-dot">{% if sl == 'Obituary & Memorial' %}<i class="fas fa-pen"></i>{% else %}6{% endif %}</div>
        <div class="rail-text">
          <span class="rail-label">Obituary</span>
          <span class="rail-sub">Legacy &amp; memorial</span>
        </div>
      </div>

      <div class="rail-step {% if sl == 'Administrative & Financial' %}active{% else %}todo{% endif %}">
        <div class="rail-dot">{% if sl == 'Administrative & Financial' %}<i class="fas fa-pen"></i>{% else %}7{% endif %}</div>
        <div class="rail-text">
          <span class="rail-label">Administrative</span>
          <span class="rail-sub">Insurance &amp; finances</span>
        </div>
      </div>

      <div class="rail-step {% if sl == 'Additional Instructions' %}active{% else %}todo{% endif %}">
        <div class="rail-dot">{% if sl == 'Additional Instructions' %}<i class="fas fa-pen"></i>{% else %}8{% endif %}</div>
        <div class="rail-text">
          <span class="rail-label">Instructions</span>
          <span class="rail-sub">Final notes &amp; messages</span>
        </div>
      </div>

      {% endwith %}

      <div class="rail-footer">
        <a href="{% url 'dashboard:funeralplan_detail' object.pk %}">
          <i class="fas fa-arrow-left"></i> Back to plan
        </a>
      </div>

    </div>
  </aside>

  <!-- ── MAIN CONTENT ─────────────────────────────────── -->
  <main class="onboarding-main">

    {% if messages %}
      {% for message in messages %}
      <div class="ob-alert ob-alert-{% if message.tags %}{{ message.tags }}{% else %}info{% endif %}">
        {% if 'success' in message.tags %}<i class="fas fa-check-circle"></i>
        {% elif 'warning' in message.tags %}<i class="fas fa-exclamation-triangle"></i>
        {% elif 'error'   in message.tags %}<i class="fas fa-times-circle"></i>
        {% else %}<i class="fas fa-info-circle"></i>
        {% endif %}
        {{ message }}
      </div>
      {% endfor %}
    {% endif %}

    <div class="ob-page-header">
      <div class="ob-eyebrow">Funeral Plan — Section Edit</div>
      <h1>{{ section_label }}</h1>
      <p>Update this section of your plan. Changes are saved immediately when you submit — your other sections remain unchanged.</p>
    </div>

    <div class="ob-body" style="grid-template-columns: 1fr;">

      <form method="post">
        {% csrf_token %}

        {% if form.non_field_errors %}
        <div class="ob-alert ob-alert-error">
          <i class="fas fa-exclamation-triangle"></i>
          {% for error in form.non_field_errors %}{{ error }}{% endfor %}
        </div>
        {% endif %}

        <div class="ob-form-card">

          <!-- ── Dynamic icon & heading per section ────────────── -->
          <div class="ob-card-heading">
            {% if section_label == 'Personal Information' %}
              <div class="ob-card-icon"><i class="fas fa-user"></i></div>
            {% elif section_label == 'Service Preferences' %}
              <div class="ob-card-icon"><i class="fas fa-church"></i></div>
            {% elif section_label == 'Final Disposition' %}
              <div class="ob-card-icon"><i class="fas fa-leaf"></i></div>
            {% elif section_label == 'Ceremony Personalization' %}
              <div class="ob-card-icon"><i class="fas fa-music"></i></div>
            {% elif section_label == 'Reception / Gathering' %}
              <div class="ob-card-icon"><i class="fas fa-utensils"></i></div>
            {% elif section_label == 'Obituary & Memorial' %}
              <div class="ob-card-icon"><i class="fas fa-pen-nib"></i></div>
            {% elif section_label == 'Administrative & Financial' %}
              <div class="ob-card-icon"><i class="fas fa-file-invoice-dollar"></i></div>
            {% else %}
              <div class="ob-card-icon"><i class="fas fa-scroll"></i></div>
            {% endif %}
            Edit: {{ section_label }}
          </div>

          <!-- ── Render all fields the section form exposes ─────── -->
          <div class="ob-grid">
            {% for field in form %}

              {% if field.field.widget.input_type == 'checkbox' %}
              {# Checkboxes get their own full-width row outside the grid #}

              {% else %}

              <div class="ob-field {% if field.field.widget.attrs.class == 'textarea' or field.field.widget.input_type == 'textarea' %}ob-full{% endif %}">
                <label for="{{ field.id_for_label }}">
                  {{ field.label }}
                  {% if field.field.required %}<span class="req">*</span>{% endif %}
                </label>
                {{ field }}
                {% if field.help_text %}
                  <span class="ob-hint">{{ field.help_text }}</span>
                {% endif %}
                {% if field.errors %}
                  <ul class="errorlist">{% for e in field.errors %}<li>{{ e }}</li>{% endfor %}</ul>
                {% endif %}
              </div>

              {% endif %}

            {% endfor %}
          </div>

          <!-- Checkboxes rendered outside the grid, full-width ── -->
          {% with has_checks=False %}
          <div class="ob-check-group" style="margin-top:1rem;">
            {% for field in form %}
              {% if field.field.widget.input_type == 'checkbox' %}
              <label class="ob-check-row">
                {{ field }}
                <span class="ob-check-label">{{ field.label }}</span>
              </label>
              {% if field.errors %}
                <ul class="errorlist">{% for e in field.errors %}<li>{{ e }}</li>{% endfor %}</ul>
              {% endif %}
              {% endif %}
            {% endfor %}
          </div>
          {% endwith %}

          <!-- ── Actions ────────────────────────────────────────── -->
          <div class="ob-actions">
            <a href="{% url 'dashboard:funeralplan_detail' object.pk %}" class="ob-btn ob-btn-ghost">
              <i class="fas fa-times"></i> Cancel
            </a>
            <div class="ob-spacer"></div>
            <a href="{% url 'dashboard:funeralplan_update' object.pk %}" class="ob-btn ob-btn-ghost">
              <i class="fas fa-list"></i> Edit Full Plan
            </a>
            <button type="submit" class="ob-btn ob-btn-accent">
              <i class="fas fa-save"></i> Save {{ section_label }}
            </button>
          </div>

        </div>
      </form>

      <!-- Contextual tip per section -->
      <div class="ob-tip">
        <div class="ob-tip-title"><i class="fas fa-lightbulb"></i>
          {% if section_label == 'Personal Information' %}About this section
          {% elif section_label == 'Service Preferences' %}Choosing a service type
          {% elif section_label == 'Final Disposition' %}Disposition options
          {% elif section_label == 'Ceremony Personalization' %}Making it personal
          {% elif section_label == 'Reception / Gathering' %}After the service
          {% elif section_label == 'Obituary & Memorial' %}Your legacy
          {% elif section_label == 'Administrative & Financial' %}Important paperwork
          {% else %}Additional guidance
          {% endif %}
        </div>
        <ul>
          {% if section_label == 'Personal Information' %}
            <li><i class="fas fa-check" style="color:var(--sixty-percent); margin-right:7px; width:12px;"></i>Used by the funeral home for official records</li>
            <li><i class="fas fa-check" style="color:var(--sixty-percent); margin-right:7px; width:12px;"></i>Veterans are entitled to specific burial honours — check the box if applicable</li>
            <li><i class="fas fa-check" style="color:var(--sixty-percent); margin-right:7px; width:12px;"></i>Religious affiliation guides the officiant and ceremony customs</li>
          {% elif section_label == 'Service Preferences' %}
            <li><i class="fas fa-check" style="color:var(--sixty-percent); margin-right:7px; width:12px;"></i>A "Celebration of Life" is less formal than a traditional funeral</li>
            <li><i class="fas fa-check" style="color:var(--sixty-percent); margin-right:7px; width:12px;"></i>Specifying a funeral home avoids family having to make that decision in grief</li>
            <li><i class="fas fa-check" style="color:var(--sixty-percent); margin-right:7px; width:12px;"></i>If you've pre-paid, include the policy number in the Administrative section</li>
          {% elif section_label == 'Final Disposition' %}
            <li><i class="fas fa-check" style="color:var(--sixty-percent); margin-right:7px; width:12px;"></i>Cremation is chosen by the majority of people today and allows flexibility</li>
            <li><i class="fas fa-check" style="color:var(--sixty-percent); margin-right:7px; width:12px;"></i>Eco-friendly options (natural burial, water cremation) are increasingly available</li>
            <li><i class="fas fa-check" style="color:var(--sixty-percent); margin-right:7px; width:12px;"></i>If you own a plot, include the plot number and cemetery contact</li>
          {% elif section_label == 'Ceremony Personalization' %}
            <li><i class="fas fa-check" style="color:var(--sixty-percent); margin-right:7px; width:12px;"></i>Specific song titles and artists remove ambiguity for the family</li>
            <li><i class="fas fa-check" style="color:var(--sixty-percent); margin-right:7px; width:12px;"></i>You can write your own eulogy points if you want to guide what's said</li>
            <li><i class="fas fa-check" style="color:var(--sixty-percent); margin-right:7px; width:12px;"></i>Name pallbearers to avoid last-minute awkwardness for the family</li>
          {% elif section_label == 'Reception / Gathering' %}
            <li><i class="fas fa-check" style="color:var(--sixty-percent); margin-right:7px; width:12px;"></i>A gathering gives people space to share memories and support each other</li>
            <li><i class="fas fa-check" style="color:var(--sixty-percent); margin-right:7px; width:12px;"></i>Even a simple home gathering is meaningful — it doesn't need to be formal</li>
          {% elif section_label == 'Obituary & Memorial' %}
            <li><i class="fas fa-check" style="color:var(--sixty-percent); margin-right:7px; width:12px;"></i>An obituary typically runs 300–500 words in a newspaper</li>
            <li><i class="fas fa-check" style="color:var(--sixty-percent); margin-right:7px; width:12px;"></i>Online obituaries (Legacy.com etc.) stay searchable indefinitely</li>
            <li><i class="fas fa-check" style="color:var(--sixty-percent); margin-right:7px; width:12px;"></i>Charity donations in lieu of flowers are increasingly preferred</li>
          {% elif section_label == 'Administrative & Financial' %}
            <li><i class="fas fa-check" style="color:var(--sixty-percent); margin-right:7px; width:12px;"></i>Most families need 8–10 certified death certificate copies</li>
            <li><i class="fas fa-check" style="color:var(--sixty-percent); margin-right:7px; width:12px;"></i>Banks, insurers, and government agencies each typically need one original</li>
            <li><i class="fas fa-check" style="color:var(--sixty-percent); margin-right:7px; width:12px;"></i>If you have a pre-paid funeral plan, include the provider's name and phone number</li>
          {% else %}
            <li><i class="fas fa-check" style="color:var(--sixty-percent); margin-right:7px; width:12px;"></i>Use this section for anything that doesn't fit elsewhere</li>
            <li><i class="fas fa-check" style="color:var(--sixty-percent); margin-right:7px; width:12px;"></i>Personal messages to your family can be recorded here</li>
            <li><i class="fas fa-check" style="color:var(--sixty-percent); margin-right:7px; width:12px;"></i>Note the location of your will, safe, or other important items</li>
          {% endif %}
        </ul>
      </div>

    </div>
  </main>
</div>

<style>
/* Suppress empty checkbox group if this section has none */
.ob-check-group:empty { display: none; }
.step-rail a.rail-step { text-decoration: none; }

/* textarea detection — crispy renders these with class 'textarea' */
.ob-grid .ob-field:has(textarea) { grid-column: 1 / -1; }
</style>
{% endblock %}